name: renovate

on:
  push:
  schedule:
    #    - cron: '5 */6 * * *'
    - cron: '*/30 * * * *'

  workflow_dispatch:

  
env:
  # RENOVATE_DRY_RUN: ${{ ((github.event_name != 'schedule' && github.event_name != 'workflow_dispatch') || (github.ref_name != 'main') && 'full' || '' }}
  RENOVATE_DRY_RUN: ${{ ((github.event_name != 'schedule' && github.event_name != 'workflow_dispatch')) && 'full' || '' }} # dry-run on main to eleminate race condition
  # RENOVATE_GIT_PRIVATE_KEY: ${{ secrets.GPG }}

jobs:
  gitlab:
    runs-on: ubuntu-24.04
  
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          show-progress: false

      - name: Restore renovate repo cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            /tmp/renovate/cache/renovate/repository
          key: repo-cache-${{ github.run_id }}
          restore-keys: |
            repo-cache-

      - name: Restore renovate package cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            /tmp/renovate/cache/renovate/renovate-cache-sqlite
          key: package-cache-${{ github.run_id }}
          restore-keys: |
            package-cache-

      - name: Restore perms
        run: |
          if [ -d /tmp/renovate ]; then
            echo "fixing renovate perms"
            sudo chown -R 12021:0 /tmp/renovate/
          fi

      - name: Renovate
        uses: renovatebot/github-action@957af03d760b2c87fc65cb95628f6d5f95d9c578 # v46.0.0
        with:
          token: ${{ secrets.GITLAB_TOKEN }}
          renovate-version: 42.92.4
          configurationFile: config.js
          docker-volumes: |
            /tmp:/tmp ;
            ${{ github.workspace }}:/github-action
        env:
          GITHUB_COM_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LOG_LEVEL: debug
          RENOVATE_PLATFORM: gitlab
          RENOVATE_REPOSITORY_CACHE: 'enabled'
          RENOVATE_GIT_AUTHOR: Renovate Bot <bot@renovateapp.com>

          RENOVATE_X_SQLITE_PACKAGE_CACHE: true

      - name: Save renovate repo cache
        if: always() && env.RENOVATE_DRY_RUN != 'full'
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            /tmp/renovate/cache/renovate/repository
          key: repo-cache-${{ github.run_id }}

      - name: Save renovate package cache
        if: always() && env.RENOVATE_DRY_RUN != 'full'
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            /tmp/renovate/cache/renovate/renovate-cache-sqlite
          key: package-cache-${{ github.run_id }}
